{% extends 'base_template.html.twig' %}

{% block content %}
	<title>{{ oa.nom }}</title>
	<style>
		/* Fond avec l'affiche */
		body {
			background: url('{{ oa.posterPath }}') no-repeat center center fixed;
			background-size: cover;
			background-attachment: scroll;
		}

		/* Opacité spécifique au conteneur principal */
		#film-container {
			background-color: rgba(244, 240, 214, 0.8); /* Légère opacité */
			padding: 20px;
			border: 1px solid #c1b494;
			border-radius: 10px;
		}

		/* Contenu interne opaque */
		#film-container > * {
			opacity: 1;
		}

		/* Animation sur l'affiche */
		.col-md-4 img {
			transition: transform 0.3s ease-in-out;
		}

		.col-md-4 img:hover {
			transform: scale(1.05);
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
		}

		/* Modal personnalisé */
		#afficheModal .modal-dialog {
			max-width: 70vw;
			pointer-events: none;
		}

		#afficheModal .modal-content {
			background: transparent;
			pointer-events: auto;
			border: none;
			overflow: hidden;
		}

		#afficheModal .modal-body img {
			max-height: 80vh;
			width: auto;
			margin: 0 auto;
		}

		/* Titre en haut à gauche */
		#afficheModal h2 {
			position: absolute;
			top: 0;
			left: 0;
			font-size: 1.5rem;
			padding: 10px 20px;
			color: #fff;
			text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
		}

		/* Croix rouge */
		#afficheModal .btn-close {
			font-size: 1.8rem;
			color: red;
			filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.8));
			background: transparent;
			opacity: 1;
		}

		#afficheModal .btn-close:hover {
			color: darkred;
		}
	</style>

	{% if oa is defined %}
		<div
			id="film-container" class="container mt-4">
			<!-- Section principale -->
			<div
				class="row">
				<!-- Affiche du film -->
				<div class="col-md-4">
					{% if oa.posterPath %}
						<img src="{{ oa.posterPath }}" alt="Affiche de {{ oa.nom }}" class="img-fluid rounded mb-3" style="max-height: 500px; object-fit: cover; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#afficheModal">
					{% else %}
						<p>
							<em>Affiche non disponible</em>
						</p>
					{% endif %}
				</div>

				<!-- Modal pour afficher l'affiche en grand -->
				<div class="modal fade" id="afficheModal" tabindex="-1" aria-labelledby="afficheModalLabel" aria-hidden="true">
					<div class="modal-dialog modal-dialog-centered modal-lg">
						<div class="modal-content">
							<div class="modal-body d-flex align-items-center p-0 position-relative">
								{% if oa.posterPath %}
									<img src="{{ oa.posterPath }}" alt="Affiche de {{ oa.nom }}" class="img-fluid" style="max-height: 80vh; object-fit: contain;">
								{% else %}
									<p>
										<em>Affiche non disponible</em>
									</p>
								{% endif %}
								<h2 class="position-absolute start-0 top-0 text-white p-3" style="font-size: 1.5rem;">{{ oa.nom }}</h2>
								<button type="button" class="btn-close position-absolute top-0 end-0 p-3" data-bs-dismiss="modal" aria-label="Fermer"></button>
							</div>
						</div>
					</div>
				</div>

				<!-- Détails du film -->
				<div class="col-md-8">
					<h1 class="text-uppercase" style="color: #5c3d1e; font-size: 2rem; font-weight: bold;">{{ oa.nom }}</h1>
					<div class="bg-light p-3 rounded">
						<div class="d-flex justify-content-between">
							<div>
								<p>
									<strong>Date de sortie :</strong>
									{{ oa.dateSortie }}</p>
								<p>
									<strong>Durée :</strong>
									{{ oa.duree }}
									min</p>
								<p>
									<strong>Genre :</strong>
									{{ oa.genres|join(', ') }}</p>
							</div>
							<div>
								<p>
									<strong>Producteur :</strong>
									{% if oa.producteur %}
										{{ oa.producteur }}
									{% else %}
										<em>Non spécifié</em>
									{% endif %}
								</p>
							</div>
						</div>
						<!-- Note du film -->
						<p>
							<strong>Note :</strong>
							{% for i in 1..5 %}
								{% if i <= (oa.note / 2) %}
									<img src="{{ 'img/noteRemplie.png' }}" alt="Note remplie" width="30" height="30">
								{% else %}
									<img src="{{ 'img/noteVide.png' }}" alt="Note vide" width="30" height="30">
								{% endif %}
							{% endfor %}
						</p>
					</div>

					<div class="d-flex mt-3">
						<a href="#commentaires" class="btn btn-sm btn-secondary me-2">Ajouter un avis</a>
						<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFilmModal">
							Ajouter l'oeuvre à une watchlist
						</button>

						<!-- Modal pour ajouter le film à une watchlist -->
						<div class="modal fade" id="addFilmModal" tabindex="-1" aria-labelledby="addFilmModalLabel" aria-hidden="true">
							<div class="modal-dialog">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title" id="addFilmModalLabel">Ajouter à une watchlist</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
									</div>
									<div class="modal-body">
										<form action="index.php?controleur=watchlist&methode=ajouterOaWatchList" method="post">
											{% if watchListListe is defined and watchListListe is not empty %}
												{% for watchlist in watchListListe %}
													<div class="mb-3">
														<div class="form-check">
															<input class="form-check-input" type="radio" name="idWatchList" value="{{ watchlist.idWatchlist }}" id="idWatchList">
															<label class="form-check-label" for="watchlist{{ watchlist.idWatchlist }}">{{ watchlist.titre }}</label>
														</div>
													</div>
												{% endfor %}
											{% else %}
												<p>Aucune watchlist trouvée.</p>
											{% endif %}
											<input type="hidden" name="idOeuvre" value="{{ oa.idOa }}">
											<button type="submit" class="btn btn-primary">Ajouter</button>
										</form>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Description -->
			<div class="mt-4 p-3 bg-light rounded">
				<h4 class="fw-bold">Description</h4>
				<p>{{ oa.description }}</p>
			</div>

			<!-- Casting -->
			{% if participants is defined and participants|length > 0 %}
				<h4 class="fw-bold">Participants</h4>
				<div class="row">
					{% for participant in participants|slice(0, 12) %}
						<div class="col-4 col-md-2 text-center mb-3">
							{% if participant.photo %}
								<img src="{{ participant.photo }}" alt="Photo de {{ participant.nom }}" class="img-thumbnail rounded-circle" style="width: 80px; height: 80px; object-fit: cover;">
							{% else %}
								<img src="https://via.placeholder.com/80x80?text=?" class="img-thumbnail rounded-circle" alt="Photo non disponible">
							{% endif %}
							<p class="mt-2 fw-bold">{{ participant.nom }}</p>
							<p class="text-muted small">{{ participant.role }}</p>
						</div>
					{% endfor %}
				</div>
			{% else %}
				<p>
					<em>Aucun participant trouvé pour ce film.</em>
				</p>
			{% endif %}


			<!-- Section des commentaires -->
			{% if commentaires is defined and commentaires is not empty %}
				<h2>Commentaires</h2>
				<ul class="list-group mb-4">
					{% for commentaire in commentaires %}
						<li class="list-group-item d-flex justify-content-between align-items-center">
							<div class="d-flex align-items-center">
								{% if commentaire.photoProfil %}
									<a href="index.php?controleur=utilisateur&methode=afficherAutreUtilisateur&pseudo={{ commentaire.pseudo }}">
										<img src="{{ 'img/profils/' ~ commentaire.photoProfil }}" alt="Photo de {{ commentaire.pseudo }}" class="rounded-circle me-3" width="50" height="50">
									</a>
								{% else %}
									<a href="index.php?controleur=utilisateur&methode=afficherAutreUtilisateur&pseudo={{ commentaire.pseudo }}">
										<img src="/img/tortueProfil.png" alt="Photo par défaut" class="rounded-circle me-3" width="50" height="50">
									</a>
								{% endif %}
								<div>
									<a href="index.php?controleur=utilisateur&methode=afficherAutreUtilisateur&pseudo={{ commentaire.pseudo }}">
										<strong>{{ commentaire.pseudo }}</strong>
									</a>
									<p>{{ commentaire.contenu }}</p>
								</div>
							</div>
							{% if utilisateurConnecte and commentaire.pseudo == utilisateurConnecte.pseudo %}
								<div>
									<a href="index.php?controleur=commentaire&methode=supprimerCommentaire&idCommentaire={{ commentaire.getIdCom }}&idOa={{ oa.idOa }}" class="btn btn-danger btn-sm" onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce commentaire ?');">
										Supprimer
									</a>
								</div>
							{% endif %}
						</li>
					{% endfor %}
				</ul>
			{% else %}
				<p>
					<em>Aucun commentaire pour ce film.</em>
				</p>
			{% endif %}

			<!-- Formulaire pour ajouter un commentaire -->
			<div id="commentaires" class="mt-4">
				{% if utilisateurConnecte %}
					<form action="index.php?controleur=commentaire&methode=ajouterCommentaire" method="post">
						<div class="mb-3">
							<label for="contenu" class="form-label">Commentaire</label>
							<textarea class="form-control" id="contenu" name="contenu" rows="3" required></textarea>
						</div>
						<input type="hidden" name="film_id" value="{{ oa.idOa }}">
						<button type="submit" class="btn btn-primary">Envoyer</button>
					</form>
				{% else %}
					<p>
						<a href="index.php?controleur=utilisateur&methode=connexion">Connectez-vous</a>
						pour ajouter un commentaire.</p>
				{% endif %}
			</div>
		</div>
	{% else %}
		<p>Le film n'existe pas.</p>
	{% endif %}
{% endblock %}
